(function(e,t){typeof define=="function"&&define.amd?define(["d3","../common/SVGWidget","../api/I2DChart","../common/Text","../common/FAChar","css!./Pie"],t):e.chart_Pie=t(e.d3,e.common_SVGWidget,e.api_I2DChart,e.common_Text,e.common_FAChar)})(this,function(e,t,n,r,i){function s(r){t.call(this),n.call(this),this._outerText=!1,this._radius=100,this._innerRadius=0,this.labelWidgets={},this.d3Pie=e.layout.pie().sort(function(e,t){return e<t?-1:e>t?1:0}).value(function(e){return e[1]}),this.d3Arc=e.svg.arc().outerRadius(this._radius).innerRadius(this._innerRadius)}return s.prototype=Object.create(t.prototype),s.prototype.constructor=s,s.prototype._class+=" chart_Pie",s.prototype.implements(n.prototype),s.prototype.publish("paletteID","default","set","Palette ID",s.prototype._palette.switch(),{tags:["Basic","Shared"]}),s.prototype.publish("useClonedPalette",!1,"boolean","Enable or disable using a cloned palette",null,{tags:["Intermediate","Shared"]}),s.prototype.size=function(e){var n=t.prototype.size.apply(this,arguments);return arguments.length&&this.radius(Math.min(this._size.width,this._size.height)/2),n},s.prototype.radius=function(e){return arguments.length?(this.d3Arc.outerRadius(e),this._radius=e,this):this._radius},s.prototype.innerRadius=function(e){return arguments.length?(this.d3Arc.innerRadius(e),this._innerRadius=e,this):this._innerRadius},s.prototype.outerText=function(e){return arguments.length?(this._outerText=e,this):this._outerText},s.prototype.intersection=function(e,t){return this.intersectCircle(e,t)},s.prototype.update=function(t,n){var s=this;this._palette=this._palette.switch(this.paletteID()),this.useClonedPalette()&&(this._palette=this._palette.cloneNotExists(this.paletteID()+"_"+this.id()));var o=n.selectAll(".arc").data(this.d3Pie(this._data),function(e){return e.data[0]});o.enter().append("g").attr("class","arc").attr("opacity",0).on("click",function(e){s.click(s.rowToObj(e.data),s._columns[1])}).each(function(t){var n=e.select(this);n.append("path").attr("d",s.d3Arc).append("title"),t.data.__viz_faChar?s.labelWidgets[t.data[0]]=(new i).char(t.data.__viz_faChar).target(this).render():s.labelWidgets[t.data[0]]=(new r).text(t.data[0]).target(this).render()}),o.transition().attr("opacity",1).each(function(t){var n={x:0,y:1};if(s._outerText){var r=Math.cos((t.startAngle+t.endAngle-Math.PI)/2),i=Math.sin((t.startAngle+t.endAngle-Math.PI)/2),o=s.labelWidgets[t.data[0]].getBBox(),u=Math.abs(r)>Math.abs(i)?o.width:o.height;n.x=r*(s._radius+u),n.y=i*(s._radius+u)}else{var a=s.d3Arc.centroid(t);n={x:a[0],y:a[1]}}var f=e.select(this);f.select("path").transition().attr("d",s.d3Arc).style("fill",function(e){return s._palette(e.data[0])}).select("title").text(function(e){return e.data[0]+" ("+e.data[1]+")"}),s.labelWidgets[t.data[0]].pos(n).render().element().classed("innerLabel",!s._outerText).classed("outerLabel",s._outerText)}),o.exit().transition().style("opacity",0).remove();if(s._outerText){var u=n.selectAll("line").data(this.d3Pie(this._data),function(e){return e.data[0]});u.enter().append("line").attr("x1",0).attr("x2",0).attr("y1",-this._radius-3).attr("y2",-this._radius-8).attr("stroke","gray").attr("transform",function(e){return"rotate("+(e.startAngle+e.endAngle)/2*(180/Math.PI)+")"}),u.transition().attr("transform",function(e){return"rotate("+(e.startAngle+e.endAngle)/2*(180/Math.PI)+")"}),u.exit().remove()}},s});